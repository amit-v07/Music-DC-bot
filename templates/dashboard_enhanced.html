<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Bot Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard_enhanced.css') }}">
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-music brand-icon"></i>
                <span>Music Bot</span>
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-tab="overview">
                    <i class="fas fa-home"></i> Overview
                </a>
                <a href="#" class="nav-item" data-tab="analytics">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
                <a href="#" class="nav-item" data-tab="servers">
                    <i class="fas fa-server"></i> Servers
                </a>
                <a href="#" class="nav-item" data-tab="controls">
                    <i class="fas fa-gamepad"></i> Controls
                </a>
            </nav>

            <div class="connection-status">
                <div class="status-indicator"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="top-bar">
                <h1 class="page-title">Dashboard Overview</h1>
                <div class="system-pills">
                    <div class="pill">
                        <i class="fas fa-microchip"></i>
                        <span id="cpu-usage">--%</span>
                    </div>
                    <div class="pill">
                        <i class="fas fa-memory"></i>
                        <span id="ram-usage">--%</span>
                    </div>
                </div>
            </header>

            <!-- Overview View -->
            <div id="view-overview" class="view-section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Plays</h3>
                            <p class="stat-value" id="total-plays">--</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Servers</h3>
                            <p class="stat-value" id="active-guilds">--</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Recent Plays (24h)</h3>
                            <p class="stat-value" id="recent-plays">--</p>
                        </div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Top Songs -->
                    <div class="card wide-card">
                        <div class="card-header">
                            <h2><i class="fas fa-fire"></i> Most Played Songs</h2>
                        </div>
                        <div class="card-body">
                            <ul class="ranking-list" id="top-songs-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>

                    <!-- System Info & Top Listeners -->
                    <div class="side-column">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-headphones"></i> Top Listeners</h2>
                            </div>
                            <div class="card-body">
                                <ul class="ranking-list" id="top-listeners-list">
                                    <li class="empty-state">Waiting for data...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="view-analytics" class="view-section">
                <div class="charts-grid">
                    <div class="card chart-card">
                        <div class="card-header">
                            <h2>Peak Activity (24h)</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                    <div class="card chart-card">
                        <div class="card-header">
                            <h2>Command Usage</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="commandsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Servers View -->
            <div id="view-servers" class="view-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Connected Servers</h2>
                        <input type="text" id="server-search" placeholder="Search servers..." class="search-input">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Server Name</th>
                                    <th>ID</th>
                                    <th>Total Plays</th>
                                    <th>Command Usage</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="servers-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Controls View -->
            <div id="view-controls" class="view-section">
                <div class="control-panel">
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-lock"></i> Admin Remote Control</h2>
                        </div>
                        <div class="card-body control-body">
                            <div class="pin-entry">
                                <label>Enter Admin PIN:</label>
                                <input type="password" id="admin-pin" placeholder="****" maxlength="4">
                            </div>

                            <div class="control-actions disabled" id="control-actions">
                                <div class="server-selector">
                                    <select id="control-server-select">
                                        <option value="">Select a server...</option>
                                    </select>
                                </div>

                                <div class="button-grid">
                                    <button class="btn btn-control" onclick="sendAction('resume')">
                                        <i class="fas fa-play"></i> Resume
                                    </button>
                                    <button class="btn btn-control" onclick="sendAction('pause')">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button class="btn btn-control" onclick="sendAction('skip')">
                                        <i class="fas fa-forward"></i> Skip
                                    </button>
                                    <button class="btn btn-control btn-danger" onclick="sendAction('stop')">
                                        <i class="fas fa-stop"></i> Stop
                                    </button>
                                </div>
                            </div>

                            <div class="separator"></div>

                            <div id="action-feedback"></div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    </main>
    </div>

    <script>
        // Socket Connection
        const socket = io();
        let activityChart = null;
        let commandsChart = null;
        let allServers = []; // Store servers data

        // Status Indicators
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.querySelector('.status-indicator');

        socket.on('connect', () => {
            statusText.textContent = 'Live';
            statusIndicator.classList.add('online');
            statusIndicator.classList.remove('offline');
        });

        socket.on('disconnect', () => {
            statusText.textContent = 'Disconnected';
            statusIndicator.classList.add('offline');
            statusIndicator.classList.remove('online');
        });

        socket.on('stats_update', (data) => {
            updateDashboard(data);
        });

        function updateDashboard(data) {
            // Update Top Pills
            document.getElementById('total-plays').textContent = data.total_plays.toLocaleString();
            document.getElementById('active-guilds').textContent = data.active_guilds;
            document.getElementById('recent-plays').textContent = data.recent_plays;

            if (data.system) {
                document.getElementById('cpu-usage').textContent = data.system.cpu + '%';
                document.getElementById('ram-usage').textContent = data.system.memory + '%';
            }

            // Update Top Songs
            const songsList = document.getElementById('top-songs-list');
            songsList.innerHTML = '';

            const sortedSongs = Object.entries(data.most_played)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10); // Show top 10

            sortedSongs.forEach(([song, count], index) => {
                const li = document.createElement('li');
                li.className = 'rank-item';
                li.innerHTML = `
                    <div class="rank-number">#${index + 1}</div>
                    <div class="rank-details">
                        <span class="song-title" title="${song}">${song}</span>
                        <span class="play-count">${count} plays</span>
                    </div>
                `;
                songsList.appendChild(li);
            });

            // Update Top Listeners
            const listenersList = document.getElementById('top-listeners-list');
            if (data.analytics && data.analytics.top_listeners) {
                listenersList.innerHTML = '';
                data.analytics.top_listeners.forEach((listener, index) => {
                    const li = document.createElement('li');
                    li.className = 'rank-item';
                    li.innerHTML = `
                         <div class="rank-number">#${index + 1}</div>
                         <div class="rank-details">
                            <span class="song-title">${listener.name}</span>
                            <span class="play-count">${listener.count} plays</span>
                         </div>
                    `;
                    listenersList.appendChild(li);
                });
            }

            // Update Charts
            if (data.analytics) {
                updateCharts(data.analytics);
            }

            // Update Server List & Selector
            if (data.servers) {
                allServers = data.servers;
                updateServerTable(data.servers);
                updateServerSelector(data.servers);
            }
        }

        // Charts Logic
        function updateCharts(analytics) {
            // Activity Chart
            const ctxActivity = document.getElementById('activityChart').getContext('2d');
            const activityData = analytics.peak_activity || Array(24).fill(0);

            if (activityChart) {
                activityChart.data.datasets[0].data = activityData;
                activityChart.update();
            } else {
                activityChart = new Chart(ctxActivity, {
                    type: 'line',
                    data: {
                        labels: [...Array(24).keys()].map(h => `${h}:00`),
                        datasets: [{
                            label: 'Plays per Hour',
                            data: activityData,
                            borderColor: '#8e44ad',
                            backgroundColor: 'rgba(142, 68, 173, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#333' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // Commands Chart (Pie/Doughnut)
            const ctxCmd = document.getElementById('commandsChart').getContext('2d');
            const cmdData = analytics.command_usage || {};
            const labels = Object.keys(cmdData);
            const values = Object.values(cmdData);

            if (commandsChart) {
                commandsChart.data.labels = labels;
                commandsChart.data.datasets[0].data = values;
                commandsChart.update();
            } else {
                commandsChart = new Chart(ctxCmd, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#fff' } }
                        }
                    }
                });
            }
        }

        // Server Table Logic
        function updateServerTable(servers) {
            const tbody = document.getElementById('servers-table-body');
            const search = document.getElementById('server-search').value.toLowerCase();

            tbody.innerHTML = '';

            const filteredServers = servers.filter(s =>
                s.guild_name.toLowerCase().includes(search) ||
                s.guild_id.toString().includes(search)
            );

            filteredServers.forEach(server => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${server.guild_name}</td>
                    <td><small>${server.guild_id}</small></td>
                    <td>${server.total_plays}</td>
                    <td>${server.command_count || 0}</td>
                    <td>${new Date(server.last_updated).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-xs" onclick="selectServerForControl('${server.guild_id}')">
                            Select
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('server-search').addEventListener('input', () => {
            updateServerTable(allServers);
        });

        // Remote Control Logic
        const pinInput = document.getElementById('admin-pin');
        const controlPanel = document.getElementById('control-actions');
        const serverSelect = document.getElementById('control-server-select');

        pinInput.addEventListener('input', (e) => {
            if (e.target.value.length >= 4) {
                controlPanel.classList.remove('disabled');
            } else {
                controlPanel.classList.add('disabled');
            }
        });

        function updateServerSelector(servers) {
            const currentVal = serverSelect.value;
            // Only update options if empty or significantly different to avoid resetting selection

            // Rebuild options but keep selection if valid
            // Simple approach: clear and rebuild
            serverSelect.innerHTML = '<option value="">Select a server...</option>';
            servers.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.guild_id;
                opt.textContent = s.guild_name;
                serverSelect.appendChild(opt);
            });

            if (currentVal && Array.from(serverSelect.options).some(o => o.value == currentVal)) {
                serverSelect.value = currentVal;
            }
        }

        function selectServerForControl(guildId) {
            document.querySelector('[data-tab="controls"]').click();
            serverSelect.value = guildId;
        }

        async function sendAction(action, payload = null) {
            const pin = pinInput.value;
            const guildId = serverSelect.value;
            const feedback = document.getElementById('action-feedback');

            if (!guildId) {
                feedback.textContent = 'Please select a server first!';
                feedback.className = 'error';
                return;
            }

            if (!pin) {
                feedback.textContent = 'Please enter PIN!';
                feedback.className = 'error';
                return;
            }

            feedback.textContent = 'Sending...';
            feedback.className = '';

            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pin,
                        action,
                        guild_id: guildId,
                        data: payload || {}
                    })
                });

                const data = await response.json();

                if (data.success) {
                    feedback.textContent = `Success: ${data.message}`;
                    feedback.className = 'success';
                } else {
                    feedback.textContent = `Error: ${data.error}`;
                    feedback.className = 'error';
                }
            } catch (err) {
                feedback.textContent = 'Network Error';
                feedback.className = 'error';
            }

            setTimeout(() => {
                if (feedback.className === 'success') feedback.textContent = '';
            }, 3000);
        }



        // Navigation Tabs
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                // Remove active class
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));

                // Add active class
                item.classList.add('active');
                const viewId = 'view-' + item.dataset.tab;
                document.getElementById(viewId).classList.add('active');

                // Update page title
                document.querySelector('.page-title').textContent = item.textContent.trim();
            });
        });
    </script>
</body>

</html>